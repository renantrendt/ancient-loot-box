<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Loot Box</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Import the Supabase client library -->
    <script type="module" src="js/supabase.js"></script>
</head>
<body>
    <!-- Login Status Bar -->
    <div class="auth-container">
        <div id="login-status">
            <button id="login-button" class="auth-button">Sign in with Google</button>
            <button id="logout-button" class="auth-button" style="display: none;">Sign Out</button>
            <span id="user-info" style="display: none;">Signed in as: <span id="user-email"></span></span>
        </div>
    </div>
    <div class="container">
        <div class="inventory-panel">
            <h2>Collected Items</h2>
            <ul id="inventory-list">
                <!-- Collected items will appear here -->
            </ul>
            <div class="conversions">
                <h3>Conversions</h3>
                <ul>
                    <li class="conversion-item" data-item="helmet" data-amount="10" onclick="handleConversion('helmet', 10)">10 Helmets = 1 Scythe</li>
                    <li class="conversion-item" data-item="bomb" data-amount="30" onclick="handleConversion('bomb', 30)">30 Bombs = 1 N.U.K.E</li>
                    <li class="conversion-item" data-item="beer" data-amount="24" onclick="handleConversion('beer', 24)">24 Beers = 1 Heineken Pack</li>
                    <li class="conversion-item" data-item="sword" data-amount="10" onclick="handleConversion('sword', 10)">10 Swords = 5 Double Swords</li>
                    <li class="conversion-item" data-item="double-sword" data-amount="30" onclick="handleConversion('double-sword', 30)">30 Double Swords = 1 Diablo Sword</li>
                    <li class="conversion-item" data-item="sniper-rifle" data-amount="4" onclick="handleConversion('sniper-rifle', 4)">4 Sniper Rifles = 1 Bazooka</li>
                    <li class="conversion-item" data-item="shotgun" data-amount="2" onclick="handleConversion('shotgun', 2)">2 Shot Guns = 1 Machine Gun</li>
                </ul>
            </div>
            <div class="bet-section">
                <button id="bet-btn">Bet</button>
            </div>
        </div>
        
        <div class="loot-box-container">
            <div class="chest-wrapper">
                <div id="epic-overlay" class="epic-overlay hidden"></div>
                <div id="loot-box" class="loot-box closed">
                    <!-- Loot box image/animation will go here -->
                </div>
            </div>
            <button id="open-box-btn">Open Loot Box</button>
            <div id="item-result" class="hidden">
                <h3 id="item-name"></h3>
                <p id="item-rarity"></p>
                <div id="item-image"></div>
            </div>
        </div>
    </div>
    
    <!-- Bet Popup Dialog -->
    <div id="bet-popup" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <h2>Place Your Bet</h2>
            <div class="form-group">
                <label for="bet-amount">Cash</label>
                <div class="input-with-symbol">
                    <input type="text" id="bet-amount">
                    <span class="currency-symbol">$</span>
                </div>
            </div>
            <div class="form-group">
                <label for="bet-item">What item do you think you will get?</label>
                <input type="text" id="bet-item">
            </div>
            <div class="signature-section">
                <p class="small-text">If you lose this, I will get your soul.</p>
                <div id="signature-pad">
                    <canvas id="signature-canvas"></canvas>
                </div>
                <p class="signature-label">Sign here</p>
            </div>
            <div class="popup-buttons">
                <button id="clear-signature">Clear Signature</button>
                <button id="confirm-bet">Confirm Bet</button>
                <button id="cancel-bet">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Win/Lose Popup -->
    <div id="result-popup" class="popup-overlay" style="display: none;">
        <div class="popup-content result-content">
            <h2 id="result-title">Result</h2>
            <p id="result-message"></p>
            <div class="popup-buttons">
                <button id="try-again-btn">Try Again</button>
                <button id="continue-btn">Continue Playing</button>
            </div>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="game-over" class="game-over-screen" style="display: none;">
        <div class="game-over-content">
            <h1>You lost your soul...</h1>
            <p>The game will close in <span id="countdown">5</span> seconds.</p>
        </div>
    </div>
    
    <!-- High Stakes Spinning Line -->
    <div id="spinning-line-container" class="spinning-line-container hidden">
        <div class="spinning-line">
            <div class="items-track" id="items-track">
                <!-- Items will be dynamically generated here -->
            </div>
            <div class="selection-indicator"></div>
        </div>
        <div class="keep-delete-buttons hidden" id="keep-delete-buttons">
            <button id="keep-btn">Keep</button>
            <button id="delete-btn">Delete</button>
        </div>
    </div>
    
    <!-- Shop Modal -->
    <div id="shop-modal" class="popup-overlay" style="display: none;">
        <div class="popup-content shop-content">
            <h2>üõí High Stakes Shop</h2>
            <div id="shop-items-list">
                <!-- Shop items will be dynamically generated here -->
            </div>
            <div class="popup-buttons">
                <button id="close-shop-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Auto Keep Settings Modal -->
    <div id="auto-keep-settings-modal" class="popup-overlay" style="display: none;">
        <div class="popup-content auto-keep-content">
            <h2>‚öôÔ∏è Auto Keep Settings</h2>
            <p>Toggle which items to automatically keep:</p>
            <div id="auto-keep-items-list">
                <!-- Auto keep toggles will be dynamically generated here -->
            </div>
            <div class="popup-buttons">
                <button id="close-auto-keep-settings-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Purchase Confirmation Modal -->
    <div id="purchase-confirm-modal" class="popup-overlay" style="display: none;">
        <div class="popup-content confirm-content">
            <h2 id="confirm-title">Confirm Purchase</h2>
            <p id="confirm-message"></p>
            <div class="popup-buttons">
                <button id="confirm-yes-btn">Yes</button>
                <button id="confirm-no-btn">No</button>
            </div>
        </div>
    </div>
    
    <!-- Auto Clicker Button -->
    <div id="auto-clicker-container">
        <button id="auto-clicker-btn">Auto Clicker</button>
    </div>
    
    <!-- High Stakes Button -->
    <div id="high-stakes-container">
        <button id="high-stakes-btn">High Stakes</button>
    </div>
    
    <!-- Shop Button (High Stakes only) -->
    <div id="shop-container" class="hidden">
        <button id="shop-btn">üõí Shop</button>
    </div>
    
    <script type="module">
        // Import Supabase functions
        import { supabase, getCurrentUser, signInWithGoogle, signOut, saveInventoryToSupabase, loadInventoryFromSupabase, saveHighStakesInventoryToSupabase, loadHighStakesInventoryFromSupabase, saveHighStakesModeStateToSupabase, loadHighStakesModeStateFromSupabase, saveShopPurchaseToSupabase, loadShopPurchasesFromSupabase, checkShopPurchaseFromSupabase, checkShopTableExists } from './js/supabase.js';
        
        // Authentication state tracking
        let currentUser = null;
        
        // Make currentUser globally accessible
        window.currentUser = null;
        
        // Make Supabase functions and client globally accessible
        window.supabase = supabase;
        window.saveInventoryToSupabase = saveInventoryToSupabase;
        window.saveHighStakesInventoryToSupabase = saveHighStakesInventoryToSupabase;
        window.loadHighStakesInventoryFromSupabase = loadHighStakesInventoryFromSupabase;
        window.saveHighStakesModeStateToSupabase = saveHighStakesModeStateToSupabase;
        window.loadHighStakesModeStateFromSupabase = loadHighStakesModeStateFromSupabase;
        window.saveShopPurchaseToSupabase = saveShopPurchaseToSupabase;
        window.loadShopPurchasesFromSupabase = loadShopPurchasesFromSupabase;
        window.checkShopPurchaseFromSupabase = checkShopPurchaseFromSupabase;
        window.checkShopTableExists = checkShopTableExists;
        
        // Debug function to check if shop table exists
        window.checkShopTable = async () => {
            if (!window.currentUser) {
                console.log('‚ùå No user logged in - cannot check shop table');
                return false;
            }
            
            console.log('üîç Checking if shop table exists...');
            const exists = await checkShopTableExists();
            
            if (exists) {
                console.log('‚úÖ Shop table exists and is working!');
                return true;
            } else {
                console.log('‚ùå Shop table does not exist!');
                console.log('üí° To fix this, go to your Supabase dashboard:');
                console.log('1. Open your Supabase project');
                console.log('2. Go to SQL Editor');
                console.log('3. Run the SQL from high_stakes_supabase.sql file');
                console.log('4. Look for the "high_stakes_shop_purchases" table section');
                return false;
            }
        };
        
        // Debug function to clear inventories table
        window.clearSupabaseInventories = async () => {
            if (!window.currentUser) {
                console.log('No user logged in');
                return;
            }
            
            try {
                console.log('Clearing inventories for user:', window.currentUser.id);
                const { error } = await supabase
                    .from('inventories')
                    .delete()
                    .eq('user_id', window.currentUser.id);
                
                if (error) {
                    console.error('Error clearing inventories:', error);
                } else {
                    console.log('Inventories cleared successfully');
                }
            } catch (error) {
                console.error('Failed to clear inventories:', error);
            }
        };

        // Test function for debugging
        window.testSupabaseConnection = async () => {
            console.log('Testing Supabase connection...');
            
            // Test items table
            try {
                const { data, error } = await supabase.from('items').select('*').limit(3);
                if (error) {
                    console.error('Error fetching items:', error);
                } else {
                    console.log('Items table test successful:', data);
                }
            } catch (error) {
                console.error('Items table test failed:', error);
            }
            
            // Test with current user if logged in
            if (window.currentUser) {
                console.log('Testing with current user ID:', window.currentUser.id);
                try {
                    const testInventory = {
                        'Test Item': { count: 1, rarity: 'common' }
                    };
                    const result = await window.saveInventoryToSupabase(window.currentUser.id, testInventory);
                    console.log('Save test result:', result);
                } catch (error) {
                    console.error('Save test failed:', error);
                }
            } else {
                console.log('No user logged in, skipping user-specific tests');
            }
        };
        
        // Check auth state on page load
        async function checkAuthState() {
            try {
                const user = await getCurrentUser();
                console.log('checkAuthState - user:', user);
                if (user) {
                    // User is signed in
                    console.log('User is signed in:', user.email, 'ID:', user.id);
                    document.getElementById('login-button').style.display = 'none';
                    document.getElementById('logout-button').style.display = 'inline-block';
                    document.getElementById('user-info').style.display = 'inline-block';
                    document.getElementById('user-email').textContent = user.email;
                    currentUser = user;
                    window.currentUser = user;
                    
                    // Load inventory from Supabase
                    console.log('Loading inventory from Supabase for user:', user.id);
                    const supabaseInventory = await loadInventoryFromSupabase(user.id);
                    if (supabaseInventory) {
                        console.log('Loaded inventory from Supabase:', supabaseInventory);
                        // Merge with local inventory if needed, or just replace
                        inventory = supabaseInventory;
                        localStorage.setItem('lootBoxInventory', JSON.stringify(inventory));
                        updateInventoryDisplay();
                    } else {
                        console.log('No inventory found in Supabase');
                    }
                    
                    // Check if user was in High Stakes mode (for browser refresh persistence)
                    const highStakesModeState = await loadHighStakesModeStateFromSupabase(user.id);
                    if (highStakesModeState && highStakesModeState.isHighStakesMode) {
                        // Restore High Stakes mode state
                        window.normalInventoryBackup = highStakesModeState.normalInventoryBackup;
                        await window.enterHighStakesMode();
                    }
                } else {
                    // User is signed out
                    console.log('User is signed out');
                    document.getElementById('login-button').style.display = 'inline-block';
                    document.getElementById('logout-button').style.display = 'none';
                    document.getElementById('user-info').style.display = 'none';
                    currentUser = null;
                    window.currentUser = null;
                }
            } catch (error) {
                console.error('Error checking auth state:', error);
            }
        }
        
        // Set up auth event listeners with error handling
        function setupAuthListeners() {
            const loginBtn = document.getElementById('login-button');
            const logoutBtn = document.getElementById('logout-button');
            
            if (loginBtn) {
                // Remove any existing listeners
                loginBtn.replaceWith(loginBtn.cloneNode(true));
                const newLoginBtn = document.getElementById('login-button');
                
                newLoginBtn.addEventListener('click', async () => {
                    try {
                        console.log('Login button clicked');
                        const { success } = await signInWithGoogle();
                        if (success) {
                            console.log('Google sign-in initiated');
                        }
                    } catch (error) {
                        console.error('Error during login:', error);
                    }
                });
            }
            
            if (logoutBtn) {
                // Remove any existing listeners
                logoutBtn.replaceWith(logoutBtn.cloneNode(true));
                const newLogoutBtn = document.getElementById('logout-button');
                
                newLogoutBtn.addEventListener('click', async () => {
                    try {
                        console.log('Logout button clicked');
                        const success = await signOut();
                        if (success) {
                            console.log('Signed out successfully');
                            currentUser = null;
                            window.currentUser = null;
                            document.getElementById('login-button').style.display = 'inline-block';
                            document.getElementById('logout-button').style.display = 'none';
                            document.getElementById('user-info').style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Error during logout:', error);
                    }
                });
            }
        }
        
        // Listen for auth state changes with better error handling
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state changed:', event, session);
            try {
                if (event === 'SIGNED_IN') {
                    console.log('User signed in:', session?.user);
                    currentUser = session?.user;
                    window.currentUser = session?.user;
                    await checkAuthState();
                } else if (event === 'SIGNED_OUT') {
                    console.log('User signed out');
                    currentUser = null;
                    window.currentUser = null;
                    // Update UI when user signs out
                    document.getElementById('login-button').style.display = 'inline-block';
                    document.getElementById('logout-button').style.display = 'none';
                    document.getElementById('user-info').style.display = 'none';
                }
                
                // Refresh auth button listeners after any auth state change
                setupAuthListeners();
            } catch (error) {
                console.error('Error handling auth state change:', error);
            }
        });
        
        // Initialize everything on page load
        async function initializePage() {
            try {
                setupAuthListeners();
                await checkAuthState();
            } catch (error) {
                console.error('Error initializing page:', error);
            }
        }
        
        // Check auth state on page load
        initializePage();
    </script>
    <script src="script.js"></script>
    <script>
        // Simple debug functions available immediately - REMOVED (now handled in script.js)
        // The fixed console commands are available in script.js as window.lootBoxConsole
    </script>
</body>
</html>
